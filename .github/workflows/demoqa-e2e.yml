name: üß™ DemoQA E2E Tests

on:
  push:
    branches: [main, develop, staging]
    paths:
      - 'cypress/**'
      - 'package*.json'
      - '.github/workflows/demoqa-e2e.yml'
  pull_request:
    branches: [main, develop, staging]
    paths:
      - 'cypress/**'
      - 'package*.json'
  workflow_dispatch:
    inputs:
      environment:
        description: 'üåç Ambiente'
        required: true
        default: 'qa'
        type: choice
        options:
          - qa
          - staging
      run_target:
        description: 'üéØ Tipo de prueba'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - api
          - ui
          - smoke
          - spec
      spec_file:
        description: 'üìÑ Ruta del spec (solo si run_target=spec)'
        required: false
        default: ''
      browser:
        description: 'üåê Navegador'
        required: false
        default: 'chrome'
        type: choice
        options:
          - chrome
          - firefox
          - edge
      debug_mode:
        description: 'üêõ Modo debug'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '18'
  CACHE_KEY: npm-${{ hashFiles('**/package-lock.json') }}

jobs:
  # Job para validar la configuraci√≥n
  validate:
    name: üîç Validar Configuraci√≥n
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Definir matriz de ambientes
        id: set-matrix
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            MATRIX="{\"environment\":\"${{ github.event.inputs.environment }}\"}"
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            MATRIX="{\"environment\":[\"qa\",\"staging\"]}"
          else
            MATRIX="{\"environment\":\"qa\"}"
          fi
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  # Job principal para ejecutar los tests
  cypress-tests:
    name: üß™ Ejecutar Tests (${{ matrix.environment }})
    runs-on: ubuntu-latest
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        environment: ${{ fromJson(needs.validate.outputs.matrix).environment }}

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: üìö Instalar Dependencias
        run: npm ci

      - name: üîê Validar Secretos
        shell: bash
        run: |
          if [ -z "${{ secrets.CYPRESS_USERNAME }}" ] || [ -z "${{ secrets.CYPRESS_PASSWORD }}" ]; then
            echo "‚ö†Ô∏è  Advertencia: Variables de sesi√≥n no configuradas en los secretos de GitHub"
            echo "Algunas pruebas pueden fallar sin credenciales v√°lidas"
          fi

      - name: üî® Construir Comando Cypress
        id: build_cmd
        shell: bash
        run: |
          # Determinar target seg√∫n el evento
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGET="${{ github.event.inputs.run_target }}"
            SPEC="${{ github.event.inputs.spec_file }}"
            BROWSER="${{ github.event.inputs.browser }}"
            DEBUG="${{ github.event.inputs.debug_mode }}"
          else
            # Para push/PR, ejecutar smoke tests en QA
            TARGET="smoke"
            BROWSER="chrome"
            DEBUG="false"
          fi

          ENVIRONMENT="${{ matrix.environment }}"
          CMD="npx cypress run --env environment=$ENVIRONMENT"

          # Agregar especificaci√≥n
          case "$TARGET" in
            all)
              echo "‚úÖ Ejecutando: Todas las pruebas"
              ;;
            api)
              CMD="$CMD --spec \"cypress/e2e/api/**/*.cy.js\""
              echo "‚úÖ Ejecutando: Pruebas API"
              ;;
            ui)
              CMD="$CMD --spec \"cypress/e2e/ui/**/*.cy.js\""
              echo "‚úÖ Ejecutando: Pruebas UI"
              ;;
            smoke)
              CMD="$CMD --spec \"cypress/e2e/ui/smoke.cy.js\""
              echo "‚úÖ Ejecutando: Smoke tests"
              ;;
            spec)
              if [ -z "$SPEC" ]; then
                echo "‚ùå Error: spec_file es requerido cuando run_target=spec"
                exit 1
              fi
              CMD="$CMD --spec \"$SPEC\""
              echo "‚úÖ Ejecutando: $SPEC"
              ;;
            *)
              echo "‚ùå Error: run_target inv√°lido: $TARGET"
              exit 1
              ;;
          esac

          # Agregar navegador
          if [ ! -z "$BROWSER" ] && [ "$BROWSER" != "chrome" ]; then
            CMD="$CMD --browser $BROWSER"
            echo "üåê Navegador: $BROWSER"
          fi

          # Agregar modo debug
          if [ "$DEBUG" = "true" ]; then
            CMD="$CMD --headed --no-exit"
            echo "üêõ Modo debug activado"
          fi

          echo "CYPRESS_CMD=$CMD" >> $GITHUB_OUTPUT
          echo "TARGET=$TARGET" >> $GITHUB_OUTPUT

      - name: üöÄ Ejecutar Cypress Tests
        uses: cypress-io/github-action@v6
        with:
          command: ${{ steps.build_cmd.outputs.CYPRESS_CMD }}
        env:
          CYPRESS_USERNAME: ${{ secrets.CYPRESS_USERNAME }}
          CYPRESS_PASSWORD: ${{ secrets.CYPRESS_PASSWORD }}
        continue-on-error: true

      - name: üìä Generar Reportes
        if: always()
        run: |
          npm run report:merge
          npm run report:generate
        continue-on-error: true

      - name: üì∏ Crear Resumen de Artifacts
        if: always()
        shell: bash
        run: |
          echo "## üìä Resultados de Tests - ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Ambiente**: ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tipo de Prueba**: ${{ steps.build_cmd.outputs.TARGET }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Rama**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìÅ Artifacts Generados" >> $GITHUB_STEP_SUMMARY
          if [ -d "cypress/artifacts" ]; then
            echo "‚úÖ Capturas de pantalla y videos disponibles" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -d "cypress/reports" ]; then
            echo "‚úÖ Reportes HTML disponibles" >> $GITHUB_STEP_SUMMARY
          fi

      - name: üì§ Subir Artifacts (Screenshots, Videos, Reports)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-artifacts-${{ matrix.environment }}
          path: |
            cypress/artifacts/screenshots/**
            cypress/artifacts/videos/**
            cypress/reports/**
          if-no-files-found: ignore
          retention-days: 30

      - name: üìà Publicar Reporte HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: html-report-${{ matrix.environment }}
          path: cypress/reports/report.html
          if-no-files-found: ignore
          retention-days: 30

  # Job para notificaciones
  notify:
    name: üì¢ Notificar Resultados
    runs-on: ubuntu-latest
    needs: [cypress-tests]
    if: always()
    steps:
      - name: ‚úÖ Pruebas Completadas
        shell: bash
        run: |
          if [ "${{ needs.cypress-tests.result }}" = "success" ]; then
            echo "‚úÖ Todos los tests pasaron correctamente"
          else
            echo "‚ö†Ô∏è  Algunos tests fallaron"
          fi

      - name: üí¨ Comentar en PR (si aplica)
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const result = "${{ needs.cypress-tests.result }}";
            const icon = result === 'success' ? '‚úÖ' : '‚ö†Ô∏è';
            const status = result === 'success' ? 'pasaron' : 'fallaron algunos';
            const message = `${icon} **Pruebas E2E**: Los tests ${status}. Revisar artifacts para m√°s detalles.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
